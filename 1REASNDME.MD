# Linux 虚拟内存与物理内存

## 分享内容

- Linux 为什么要用虚拟内存？
- 什么是虚拟内存和物理内存？
- 虚拟内存和物理内存如何映射？
- `malloc` 背后到底发生了什么？
- 什么是分页、缺页异常、页表？
- swap 有什么作用？

---

## 1.为什么需要虚拟内存？

### 问题

如果一个程序 *直接访问物理内存* 会有什么问题？

- 程序之间容易互相覆盖内存导致崩溃
- 程序需要连续大内存很难满足（碎片问题）
- 程序地址需要跟物理硬件紧密绑定，写程序很痛苦
- 不能让程序使用超过物理 RAM 的空间

### 虚拟内存的意义
  
虚拟内存是操作系统为每个进程提供的、与实际物理内存**无关的、独立的、连续的大型**地址空间。

它本质是一种 抽象，并不真实存在于硬件里。

> 程序看到的内存（虚拟） ≠ 真实内存（物理）

---

## 2.虚拟内存：进程看到的地址空间结构

在 Linux 中，每个进程看到的虚拟地址空间大致如下：

```
+--------------------------+
|       栈 Stack           |
+--------------------------+
|        动态库           |
+--------------------------+
|       堆 Heap            |
+--------------------------+
| data 区、bss 区、代码区  |
+--------------------------+
|       内核空间           |
+--------------------------+
```

特点：

- 每个进程都有 **独立且一致** 的结构
- 程序不需要关心物理内存在哪里

---

## 3.物理内存：真实的 RAM

物理内存是机器上的真实硬件：

- 有限的
- 不连续
- 会被多个程序共享
- 内核负责分配、回收和保护

程序 **永远不能直接访问物理内存**，只能通过虚拟内存间接访问。

---

## 4.Linux 如何把虚拟内存映射到物理内存？

靠 **页** 和 **页表**。

### 页

- 虚拟内存和物理内存都被切成小块
- 默认大小：4KB

### 页表

记录了

> 虚拟页 → 物理页

访问流程：

虚拟地址  
→ MMU 查页表  
→ 映射到物理地址

---

## 5.分页

分页的三个核心点：

1. 程序的虚拟地址被分成虚拟页
2. 内核从物理内存中分配物理页
3. 页表记录虚拟页和物理页的对应关系

分页的优势：

- 内存隔离（安全）
- 避免物理内存碎片
- 支持比 RAM 更大的空间（依赖 swap）
- 提高内存利用率

---

## 6.缺页异常

当进程访问某个虚拟地址，而该页：

- 没有物理页，或
- 在 swap 里

就会发生 **缺页异常（Page Fault）**。

### 缺页异常流程：

1. CPU 查页表没有映射 → 触发缺页异常
2. 内核介入判断合法性
3. 若合法 → 分配物理页并更新页表
4. 若不合法 → `Segmentation Fault`

**物理内存大多数是在缺页时分配的，而不是在 malloc 时**

---

## 7.malloc 与虚拟内存、物理内存的关系（超重要）

### 🔹 malloc 做了什么？

当你写：

```c
p = malloc(1024);
```

`malloc` 并不会分配物理内存。

它会：

- 检查堆空间是否够
- 不够则调用 `brk` / `mmap` 向内核申请一段 **虚拟地址区域（VMA）**

此时没有物理内存！

### 🔹 什么时候分配物理内存？

当你 **第一次访问** 这片区域：

```c
p[0] = 1;
```

会导致：

1. 触发缺页异常
2. 内核分配物理页
3. 页表建立映射

这叫 **按需分配（Demand Paging）**。

---

## 8.swap —— 虚拟内存的“外部仓库”

当物理内存不足时：

1. 内核把冷门页写到 swap
2. 释放物理页给热点页使用
3. 再访问时从 swap 拉回（很慢）

优势：

- 进程可以看到超过 RAM 的空间
- 系统不容易 OOM

缺点：

- 性能显著下降（磁盘远比内存慢）

---

## 9.整体流程图

```
malloc
  ↓
内核分配一段虚拟内存（VMA）
  ↓
程序未访问 → 不分配物理内存
  ↓（第一次访问）
触发缺页异常 Page Fault
  ↓
内核分配物理页
  ↓
建立虚拟页 → 物理页映射
  ↓
后续访问直接命中页表
```

---

## 10.总结

- 程序看到的是 **虚拟内存**，不是物理内存
- 虚拟内存让程序觉得有连续、安全、大空间
- 内核用 **页 + 页表** 管理虚拟 → 物理映射
- `malloc` 只分配虚拟内存
- **物理内存是在第一次访问时分配（缺页异常）**
- swap 扩展内存但速度慢
- 分页让内存管理高效、灵活、安全

