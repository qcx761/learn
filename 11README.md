## 4. Linux 如何把虚拟内存映射到物理内存？

Linux 使用 **分页机制** 来管理虚拟内存和物理内存。分页机制将虚拟内存和物理内存都划分为固定大小的块，使得虚拟地址到物理地址的映射能够高效、安全地进行。核心概念是：

> **虚拟地址 → 页表 → 物理页框**  

当程序访问的虚拟地址没有对应物理页时，会触发 **缺页异常**，操作系统再为其分配物理页，并更新页表映射。

分页机制不仅解决了连续内存分配的碎片问题，还为内存保护、按需分配、大虚拟空间提供了基础支持。

---

## 页

### 1. 页的概念
页是 Linux 系统中虚拟内存和物理内存管理的**最小单位**。  
- 操作系统把虚拟内存划分为固定大小的虚拟页，同时把物理内存划分为等大小的物理页框。  
- 默认页大小通常为 **4KB**，但在一些系统中，也支持大页（2MB 或 1GB）。  
- 每页包含连续的虚拟地址，但物理内存页框不必连续。

> 页的大小类似于城市中的“地块”，每个地块可以存放固定面积的建筑。虚拟页和物理页就像地块的规划，虚拟页看似连续，物理页可以分散，但通过“地图”（页表）可以找到对应位置。

---

### 2. 页的作用
分页不仅是内存管理单位，更有多重作用：

1. **内存隔离与安全**  
   - 每个进程拥有独立的虚拟页空间，进程之间无法直接访问对方的内存  
   - 内核页表可以设置访问权限（只读、只写、可执行）  
   - 防止程序越界访问引发系统崩溃或数据泄漏  

2. **减少碎片**  
   - 物理内存不必连续，避免传统连续分配产生的外部碎片  
   - 内核可以把物理页分散分配，同时虚拟页对程序来说是连续的  

3. **按需分配**  
   - 内核在程序访问虚拟页时才分配物理页  
   - 未访问的虚拟页不占用物理内存，提高整体内存利用率  

4. **支持大虚拟地址空间**  
   - 程序看到的虚拟地址空间通常远大于物理内存  
   - 依赖 swap 或按需分配机制，可以让程序申请超过物理内存的空间  

---

### 3. 页的映射示例
假设一个进程申请 **8KB** 内存：  

- 虚拟地址空间被划分为两页，每页 4KB  
- 操作系统为这两页分配物理页框（可能不连续），并建立映射  
- 程序访问虚拟地址 `0x1000` 时 → 页表映射到物理页 #50  
- 程序访问虚拟地址 `0x2000` 时 → 页表映射到物理页 #201  

> 注意：虽然虚拟地址连续，但物理页可能分散，分页机制让程序感知不到物理内存的碎片。

---

## 页表

### 1. 页表概念
页表是操作系统维护的 **虚拟页到物理页的映射表**。  
每个进程都有自己的页表，记录虚拟页对应的物理页号、访问权限、状态信息等。CPU 内存管理单元（MMU）通过页表将虚拟地址转换为物理地址，实现虚拟内存访问。

---

### 2. 多级页表
直接建立单级页表会占用巨大的内存空间，尤其在 64 位系统中。  
Linux 采用 **多级页表** 结构来降低开销：

- 64 位系统通常使用 **4 级或 5 级页表**  
- 每级页表只管理虚拟地址的一部分  
- 最终映射到物理页框  

#### 优势：
- 节省内存：未使用的虚拟页无需占用页表空间  
- 支持稀疏分配：只为访问过的页建立页表条目  

---

### 3. 页表条目内容
每个页表条目保存的信息包括：

- 物理页框号  
- 访问权限（读/写/执行）  
- 页状态（是否在物理内存、是否修改过）  
- 缓存策略（是否可缓存、是否写回）  

通过这些信息，CPU 可以快速将虚拟地址映射到物理地址，并进行访问权限检查。

---

## 分页机制总结

分页的三个核心流程：

1. 程序的虚拟地址被划分为虚拟页  
2. 内核为虚拟页分配物理页框  
3. 页表记录虚拟页 → 物理页的映射关系  

分页机制带来的优势：

- **内存隔离**：防止进程互相干扰  
- **减少碎片**：物理内存不必连续  
- **支持大虚拟空间**：超出物理内存大小  
- **按需分配**：节省内存，提高利用率  

> 分页机制是虚拟内存管理的基石，也是现代操作系统内存管理的核心设计。

---

## 缺页异常

当进程访问某个虚拟地址，而该页：

- 没有对应物理页，或在 swap 中（被换出磁盘）  

就会触发 **缺页异常**，操作系统介入处理。

---

### 缺页异常处理流程

1. CPU 查页表没有映射 → **触发缺页异常**  
2. 内核介入判断访问是否合法  
   - 合法 → 分配物理页并更新页表  
   - 不合法 → 抛出 `Segmentation Fault`（段错误）  
3. 程序恢复执行，访问命中页表  

> 注意：**物理内存大多数是在缺页时分配**。  
> 这就是按需分配的核心思想：虚拟地址空间可以先保留，而物理页只有在实际访问时才分配，提高内存利用效率。

---

### 缺页异常示意图

```
程序访问虚拟地址
    ↓
CPU 查页表
    ↓
没有映射？ → 是 → 触发 Page Fault
    ↓
内核判断是否合法访问
    是      否 → Segmentation Fault
    ↓       
分配物理页更新页表
    ↓
程序继续执行
```
---

### 总结

- Linux 使用 **分页机制** 将虚拟内存映射到物理内存  
- **页** 是内存管理的最小单位，提供隔离、按需分配和碎片控制  
- **页表** 记录虚拟页与物理页的映射，并管理权限  
- **多级页表** 节省内存开销，支持稀疏分配  
- **缺页异常** 是物理页分配的触发机制  
- **按需分配** 让虚拟内存空间可以远大于物理内存，提高系统效率和灵活性
